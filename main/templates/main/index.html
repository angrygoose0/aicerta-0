{% extends 'main/base.html' %}
{% load static %}
{% load crispy_forms_tags %}


{% block title %}Document{% endblock %}


{% block content %}

    <div class="row">
        
        <div class="col {% if doc.file %} scrolling-column {% endif %}">
            <div class="container position-relative">
                <!-- Eye Icon Button at the top right -->
                <a href="/app/{{doc.id}}/preview" class="btn btn-icon position-absolute top-0 end-0 m-2" title="View">
                    <i class="fas fa-eye"></i>
                </a>
                <button type="button" class="btn btn-icon position-absolute top-0 m-2" style="right: 2.5rem;" data-bs-toggle="modal" data-bs-target="#OCRModal">
                    <i class="fas fa-upload"></i>
                </button>
                <!--button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ResultsModal">
                    Show OCR Modal
                </button-->
                

                
                <div class='exam'>
                    <div class="py-3">
                        <h1>{{doc.name}}</h1>
                        <small><b>Standard: {{doc.exam.standard}}</b></small> 
                        <br>
                        <small><b>Year: {{doc.exam.year}}</b></small>
                    </div>
                    
                    {% include "main/partials/forms.html" %}

                    <div>
                        <a class="btn btn-outline-success" href="{% url 'prepare_mark' doc.id %}" role="button">Mark</a>
                    </div>
                </div>
            </div>
        </div>
        {% if doc.file %}
            <div class="container scrolling-column">
                <button class="btn btn-sm btn-icon" id="prev-page">
                    <i class="fas fa-arrow-circle-left"></i>
                </button>
                <button class="btn btn-sm btn-icon" id="next-page">
                    <i class="fas fa-arrow-circle-right"></i>
                </button>
                <button class="btn btn-sm btn-icon" id="crop-button-text">
                    <i class="fas fa-font"></i>
                </button>
                <button class="btn btn-sm btn-icon" id="crop-button-math">
                    <i class="fas fa-superscript"></i>
                </button>
                

                <div class="py-3">
                    <span class="page-info">
                        Page <span id="page-num">1</span> of <span id="page-count"></span>
                    </span>
        
                    <canvas id="pdf-render"></canvas>
                    <form action="{% url 'save_image' id=doc.id %}" 
                        id="imageForm" 
                        method="POST" 
                        enctype="multipart/form-data"
                        style="display: none;">
                        {% csrf_token %}
                        {{ ocrform.image|as_crispy_field }}
                        

                    </form>

        
        
                </div>
            </div>
        {% endif %}
    </div> 

    <div class="modal fade" id="ResultsModal" tabindex="-1" aria-labelledby="ResultsModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl"> <!-- Increase modal size to modal-xl for better visibility -->
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="ResultsModalLabel">OCR Results</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <!-- Column for the cropped image -->
                        <div class="col-md-6">
                            <img id="croppedImage" src="" alt="Cropped Image" class="img-fluid"> <!-- Image will be loaded dynamically -->
                        </div>
                        
                        <!-- Column for the OCR text -->
                        <div class="col-md-6">
                            <textarea class="form-control" id="ocrText" rows="10" placeholder="OCR Results will appear here..."></textarea> <!-- Text area to edit OCR results if needed -->
                        </div>
                    </div>
                </div>
    
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="insertOCRBtn">Insert Results</button>
                </div>
            </div>
        </div>
    </div>
    

    <div class="modal fade" id="latexModal" tabindex="-1" aria-labelledby="latexModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="latexModalLabel">Insert LaTex</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    
                    <div class="mathquill-container py-2">
                        <div class="btn-toolbar mb-2 " role="toolbar" aria-label="Toolbar with button groups">
                            <!-- Arithmetic & Basic Algebra Group -->
                            <div class="btn-group me-2" role="group" aria-label="Arithmetic">
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="+">+</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="-">-</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\times">\(\times\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\div">\(\div\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\pm">\(\pm\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\mp">\(\mp\)</button>
                            </div>
                        
                            <!-- Relations & Equivalents Group -->
                            <div class="btn-group me-2" role="group" aria-label="Relations">
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="=">=</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\neq">\(\neq\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\approx">\(\approx\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\equiv">\(\equiv\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="<"><</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex=">">></button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\leq">\(\leq\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\geq">\(\geq\)</button>
                            </div>
                        
                            <!-- Calculus Group -->
                            <div class="btn-group me-2" role="group" aria-label="Calculus">
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\int">\(\int\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\partial">\(\partial\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\lim_{x \to a}">\(\lim\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\sum">\(\sum\)</button>
                            </div>
                        
                            <!-- Greek Letters Group (only a few for the sake of brevity) -->
                            <div class="btn-group me-2" role="group" aria-label="Greek Letters">
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\alpha">\(\alpha\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\beta">\(\beta\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\gamma">\(\gamma\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\delta">\(\delta\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\lambda">\(\lambda\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\Omega">\(\Omega\)</button>
                            </div>
                        
                            <!-- Miscellaneous Group -->
                            <div class="btn-group" role="group" aria-label="Miscellaneous">
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\infty">\(\infty\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\sqrt{}">\(\sqrt{}\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\angle">\(\angle\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\therefore">\(\therefore\)</button>
                                <button type="button" class="btn btn-sm btn-light math-button" data-latex="\because">\(\because\)</button>
                            </div>
                        </div>
                        <p><span class="mathquill-input"></span></p>
                        <button type="button" class="btn btn-outline-success add-mathquill-btn">+</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="insertLatexBtn">Insert</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade modal-lg" id="OCRModal" tabindex="-1" aria-labelledby="OCRModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="OCRModalLabel">OCR</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <div class="row">
                        {% for file in files %}
                            <div class="col-2">


                                <form action="{% url 'file_to_doc' doc.id file.id %}" method="POST" class="card-form">
                                    {% csrf_token %}
                                    <button type="submit" class="card box-shadow card-hoverable mb-2" style="text-decoration: none; border: none; background: none;">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ file.name|truncatechars:15 }}</h5>
                                            <p class="card-text">{{ file.file|truncatechars:15 }}</p>
                                            <!-- You can add more details of the file here -->
                                            <!-- Add hidden inputs if you have any data to send with the POST request -->
                                            <!-- <input type="hidden" name="someName" value="someValue"> -->
                                        </div>
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                        
                        <div class="col-2">
                            <a href="/app/{{doc.id}}/upload" class="card mb-2" style="text-decoration: none;">
                                <div class="card-body d-flex justify-content-center align-items-center" style="height: 100%;">
                                    <span style="font-size: 3rem; color: #376d4d;">+</span>
                                </div>
                            </a>
                        </div>
    
                    <div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success">Close or Save or whatever action you need</button>
                </div>
            </div>
        </div>
    </div>

    
    



{% endblock %}

{% block scripts %}
    <script src="{% static 'js/index.js' %}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        
            {% if development %}
                const url = "{{doc.file.file.url}}"; 
            {% else %}
            {% if doc.file %}
                const url = "{% url 'serve_protected_file' doc.file.id %}";
                {% else %}
                    const url = "";  // or some default value
                {% endif %}
            {% endif %}

            let pdfDoc = null,
                pageNum = 1,
                pageIsRendering = false
                pageNumIsPending = null;

            const scale = 1.8,
                canvas = document.querySelector('#pdf-render'),
                ctx = canvas.getContext('2d')

            // Render the page

            const renderPage = num => {
                pageIsRendering = true;
            
                // Get Page
                pdfDoc.getPage(num).then(page => {
                    const viewportOriginal = page.getViewport({ scale: 1 });
                    const containerWidth = document.querySelector('.container').clientWidth;
                    const desiredWidth = containerWidth - 40; // 40px is the margin of the .exam class
                    const scale = desiredWidth / viewportOriginal.width;
            
                    const viewport = page.getViewport({ scale });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
            
                    const renderCtx = {
                        canvasContext: ctx,
                        viewport
                    };
            
                    page.render(renderCtx).promise.then(() => {
                        pageIsRendering = false;
            
                        if(pageNumIsPending !== null) {
                            renderPage(pageNumIsPending);
                            pageNumIsPending = null;
                        }
                    });
            
                    // Output current page
                    document.querySelector('#page-num').textContent = num;
                });
            };        

            // Check for pages pages rendering
            const queueRenderPage = num => {
                if(pageIsRendering) {
                    pageNumIsPending = num;   
                } else {
                    renderPage(num);
                }
            }

            // Show Prev Page
            const showPrevPage = () => {
                if(pageNum <= 1) {
                    return;
                }
                pageNum--;
                queueRenderPage(pageNum);
            }

            // Show Next Page
            const showNextPage = () => {
                if(pageNum >= pdfDoc.numPages) {
                    return;
                }
                pageNum++;
                queueRenderPage(pageNum);
            }

            // Get Document
            pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
                pdfDoc = pdfDoc_;
                console.log(pdfDoc);

                document.querySelector('#page-count').textContent = pdfDoc.numPages;

                renderPage(pageNum)
            });

            // Button events
            document.querySelector('#prev-page').addEventListener('click', showPrevPage);
            document.querySelector('#next-page').addEventListener('click', showNextPage);

            // Resize event listener
            window.addEventListener('resize', () => {
                if (pdfDoc) {
                    queueRenderPage(pageNum);
                }
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {

            let cropping = false;
            let cropper;
        
            const cropButtonText = document.getElementById('crop-button-text');
            const cropButtonMath = document.getElementById('crop-button-math');
        
            const iconText = cropButtonText.querySelector('.fas');
            const iconMath = cropButtonMath.querySelector('.fas');
        
            const form = document.getElementById('imageForm');
            const imageInput = document.getElementById('id_image');
            const imageDataInput = document.getElementById('imageData');
        
            function enterCroppingState(cropButton, cropIcon, otherButton, cropMethod) {
                cropping = true;
                cropIcon.classList.remove(cropMethod === "math" ? 'fa-superscript' : 'fa-font');
                cropIcon.classList.add('fa-check');
                otherButton.disabled = true;
        
                const canvas = document.getElementById('pdf-render');
                cropper = new Cropper(canvas);
            }
        
            function confirmCroppingState(cropIcon, cropMethod) {
                if (cropper) {
                    const croppedCanvas = cropper.getCroppedCanvas();
                    const croppedImageDataURL = croppedCanvas.toDataURL('image/png');
                    
                    const byteString = atob(croppedImageDataURL.split(',')[1]);
                    const mimeString = croppedImageDataURL.split(',')[0].split(':')[1].split(';')[0];
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    const blob = new Blob([ab], { type: mimeString });
                    
                    const file = new File([blob], 'cropped_image.png', { type: mimeString });
                    
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    imageInput.files = dataTransfer.files;
        
                    const formData = new FormData(form);
                    formData.append('crop_method', cropMethod);
                    $.ajax({
                        url: form.action,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.status === 'success') {
                                document.getElementById('ocrText').value = response.ocr_result;
                                document.getElementById('croppedImage').src = response.cropped_image_url;
                                $('#ResultsModal').modal('show');
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function() {
                            alert('An error occurred. Please try again.');
                        }
                    });
                    
                    cropper.destroy();
                    cropping = false;
                    cropIcon.classList.remove('fa-check');
                    cropIcon.classList.add(cropMethod === "math" ? 'fa-superscript' : 'fa-font');
                    cropButtonMath.disabled = false;
                    cropButtonText.disabled = false;
                }
            }
        
            cropButtonText.addEventListener('click', function(event) {
                event.preventDefault();
                if (!cropping) {
                    enterCroppingState(cropButtonText, iconText, cropButtonMath, "text");
                } else {
                    confirmCroppingState(iconText, "text");
                }
            });
        
            cropButtonMath.addEventListener('click', function(event) {
                event.preventDefault();
                if (!cropping) {
                    enterCroppingState(cropButtonMath, iconMath, cropButtonText, "math");
                } else {
                    confirmCroppingState(iconMath, "math");
                }
            });
        });

    </script>

    <script src="{% static 'js/ocrinsert.js' %}"></script>
{% endblock %}
