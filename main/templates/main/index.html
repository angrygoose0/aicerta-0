{% extends 'main/base.html' %}
{% load static %}
{% load crispy_forms_tags %}


{% block title %}Document{% endblock %}


{% block content %}
    <div class="container-fluid">
        <div class="row">
            
            <div class="col {% if doc.file %} scrolling-column {% endif %}">
                <div class="container position-relative">
                    <!-- Eye Icon Button at the top right -->
                    <a href="/app/{{doc.id}}/preview" class="btn btn-icon position-absolute top-0 end-0 m-2" title="View">
                        <i class="fas fa-eye"></i>
                    </a>
                    <button type="button" class="btn btn-icon position-absolute top-0 m-2" style="right: 2.5rem;" data-bs-toggle="modal" data-bs-target="#OCRModal">
                        <i class="fas fa-upload"></i>
                    </button>
                    <button type="button" class="btn btn-icon position-absolute top-0 m-2" style="right: 5rem;" data-bs-toggle="modal" data-bs-target="#latexModal">
                        <i class="fas fa-square-root-alt"></i>
                    </button>   
                    {% if doc.assignment.status == 1 %}
                        <div class="countdown-timer" id="timer-{{ doc.assignment.id }}" data-ends-at="{{ doc.assignment.ends_at|date:'c' }}" ><small class="text-muted">Time left: Calculating...</small></div>
                    {% endif %}          
                    <div class='exam'>
                        <div class="py-3">
                            <h1>{{doc.name}}</h1>
                            <small><b>Standard: {{doc.exam.standard}}</b></small> 
                            <br>
                            <small><b>Year: {{doc.exam.year}}</b></small>
                        </div>
                        
                        {% include "main/partials/forms.html" %}
                    </div>
                </div>
            </div>
            {% if doc.file %}
                <div class="col scrolling-column">
                    <div class="container position-relative">
                        <button class="btn btn-sm btn-icon" id="prev-page">
                            <i class="fas fa-arrow-circle-left"></i>
                        </button>
                        <button class="btn btn-sm btn-icon" id="next-page">
                            <i class="fas fa-arrow-circle-right"></i>
                        </button>
                        <button class="btn btn-sm btn-icon" id="crop-button-text">
                            <i class="fas fa-font"></i>
                        </button>
                        <button class="btn btn-sm btn-icon" id="crop-button-math">
                            <i class="fas fa-superscript"></i>
                        </button>
                        

                        <div class="py-3">
                            <span class="page-info">
                                Page <span id="page-num">1</span> of <span id="page-count"></span>
                            </span>
                
                            <canvas id="pdf-render"></canvas>
                            <form action="{% url 'save_image' id=doc.id %}" 
                                id="imageForm" 
                                method="POST" 
                                enctype="multipart/form-data"
                                style="display: none;">
                                {% csrf_token %}
                                {{ ocrform.image|as_crispy_field }}
                                

                            </form>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div> 
    </div>

    <div class="modal fade" id="ResultsModal" tabindex="-1" aria-labelledby="ResultsModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl"> <!-- Increase modal size to modal-xl for better visibility -->
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="ResultsModalLabel">OCR Results</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <!-- Column for the cropped image -->
                        <div class="col-md-6">
                            <img id="croppedImage" src="" alt="Cropped Image" class="img-fluid"> <!-- Image will be loaded dynamically -->
                        </div>
                        
                        <!-- Column for the OCR text -->
                        <div class="col-md-6">
                            <textarea class="form-control" id="ocrText" rows="10" placeholder="OCR Results will appear here..."></textarea> <!-- Text area to edit OCR results if needed -->
                        </div>
                    </div>
                </div>
    
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="insertOCRBtn">Insert Results</button>
                </div>
            </div>
        </div>
    </div>
    

    <div class="modal fade" id="latexModal" tabindex="-1" aria-labelledby="latexModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="latexModalLabel">Insert LaTex</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <!--div class="col-md-6">
                            <img id="croppedLatexImage" src="" alt="Cropped Latex Image" class="img-fluid"> <!-- Image will be loaded dynamically -->
                        <!--/div-->
                        <div class="col">
                            <div class="mathquill-container py-2">

                                {% include "main/partials/math-btns.html" %}
                                <p><span class="mathquill-input"></span></p>
                                <button type="button" class="btn btn-outline-success add-mathquill-btn">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="insertLatexBtn">Insert</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade modal-lg" id="OCRModal" tabindex="-1" aria-labelledby="OCRModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="OCRModalLabel">OCR</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <div class="row">
                        {% for file in files %}
                            <div class="col-2">


                                <form action="{% url 'file_to_doc' doc.id file.id %}" method="POST" class="card-form">
                                    {% csrf_token %}
                                    <button type="submit" class="card box-shadow card-hoverable mb-2" style="text-decoration: none; border: none; background: none;">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ file.name|truncatechars:15 }}</h5>
                                            <p class="card-text">{{ file.file|truncatechars:15 }}</p>
                                            <!-- You can add more details of the file here -->
                                            <!-- Add hidden inputs if you have any data to send with the POST request -->
                                            <!-- <input type="hidden" name="someName" value="someValue"> -->
                                        </div>
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                        
                        <div class="col-2">
                            <a href="/app/{{doc.id}}/upload" class="card mb-2" style="text-decoration: none;">
                                <div class="card-body d-flex justify-content-center align-items-center" style="height: 100%;">
                                    <span style="font-size: 3rem; color: #376d4d;">+</span>
                                </div>
                            </a>
                        </div>
    
                    <div>
                </div>
            </div>
        </div>
    </div>

    
    



{% endblock %}

{% block scripts %}
    <script>
        {% if development_mode %}
            const url = "{{doc.file.file.url}}";         
        {% else %}
            const url = "{{signed_url|safe}}";
        {% endif %}
    </script>
    <script src="{% static 'js/index.js' %}"></script>

    <script>
        function calculateTimeLeft(endsAt) {
            const now = new Date();
            const endTime = new Date(endsAt);
            const difference = endTime - now;

            if (difference <= 0) {
                return null;  // Past the end time
            }

            const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((difference / 1000 / 60) % 60);
            const seconds = Math.floor((difference / 1000) % 60);

            return `${hours}h ${minutes}m ${seconds}s`;
        }

        function updateTimer() {
            const timerElement = document.getElementById('timer-{{ doc.assignment.id }}');
            const endsAt = timerElement.getAttribute('data-ends-at');

            const timeLeft = calculateTimeLeft(endsAt);
            if (timeLeft) {
                timerElement.innerHTML = `<small class="text-muted">Time left: ${timeLeft}</small>`;
            } else {
                timerElement.innerHTML = `<small class="text-muted">Ended at: ${endsAt}</small>`;
            }
        }

        setInterval(updateTimer, 1000);  // Update every second
    </script>

{% endblock %}
