{% load static %}
<!doctype html>
<html lang="en">
    <head>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <!-- htmx -->
        <script src="https://unpkg.com/htmx.org@1.9.0"></script>

        <!-- Math Quill -->
        <link rel="stylesheet" href="{% static 'css/mathquill.css' %}">

        


        <!-- MathJax -->
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:400,700|Lato:400,700&display=swap" rel="stylesheet">

        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500&display=swap" rel="stylesheet">

        <link rel="preconnect" href="https://fonts.googleapis.com">

        <!--bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
        <!-- css -->
        <link rel="stylesheet" href="{% static 'css/main.css' %}">
        <title>{% block title%} {% endblock %}</title>

        <!-- font-awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">


    </head>
    <body>
        
        <div class="sidenav">
            <a href="/app/">Home</a>
            <a href="/app/create">Create</a>
            <a href="/app/account">Account</a>
            <a href="/app/support">Support</a>
        </div>

        <div id="content", name="content", class="main">      
            {% block content%}
            {% endblock %}

        </div>

        <div class="toast-container bottom-0 end-0 p-3" id="toast-container">
        </div>

        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
        
        <!-- Mathquill JS-->
        <script src="{% static 'js/mathquill.js' %}"></script>

        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

        {% block scripts%}
        {% endblock %}
        
        <script>
            function hideToastAndNavigate(event, toastId, url) {
                event.preventDefault(); // Prevent default navigation
            
                // Hide the toast
                let toastEl = document.getElementById(toastId);
                let bootstrapToast = new bootstrap.Toast(toastEl);
                bootstrapToast.hide();
            
                // Navigate to the URL after a short delay to ensure the toast hides smoothly
                setTimeout(() => {
                    window.location.href = url;
                }, 300); // 300ms delay, you can adjust as needed
            }
            
        </script>

        <script>
            
            const socket = new WebSocket(
                'wss://' + window.location.host + '/ws/notifications/'
            );
        
            // Function to store toast data in localStorage
            function storeToastData(data) {
                if (isToastDismissed(data.task_id) && data.progress !== 100) {
                    return;
                }
                let toasts = JSON.parse(localStorage.getItem('toasts')) || [];
                data.timestamp = moment().toISOString();

                
                // Check if a toast with the given task_id already exists
                const existingToastIndex = toasts.findIndex(toast => toast.task_id === data.task_id);

                if (existingToastIndex > -1) {
                    // If it exists, update the existing toast data with the new data
                    toasts[existingToastIndex] = data;
                } else {
                    // If it doesn't exist, push the new data to the array
                    toasts.push(data);
                }

                localStorage.setItem('toasts', JSON.stringify(toasts));
            }

            function isToastDismissed(task_id) {
                let dismissedToasts = JSON.parse(localStorage.getItem('dismissedToasts')) || [];
                return dismissedToasts.includes(task_id);
            }
            


            // Function to render a toast
            function renderToast(data) {
                let content;

                if (data.error) {
                    content = `
                        ${data.exam_name}
                        <div class="alert alert-danger mt-2" role="alert">
                            Error: ${data.error}
                        </div>
                        `;
                } else if (data.progress < 100) {
                    content = `
                        ${data.exam_name}
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: ${data.progress}%" aria-valuenow="${data.progress}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        `;
                } else {
                    content = `
                        ${data.exam_name}
                        <a class="btn btn-sm btn-outline-success" href="/app/${data.doc_id}/view" onclick="hideToastAndNavigate(event, 'toast-${data.task_id}', '/app/${data.doc_id}/view')">View Marks</a>`;
                }
            
                let toastHTML = `
                    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false" id="toast-${data.task_id}">
                        <div class="toast-header">
                            <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #376d4d;"></div>
                            <strong class="me-auto">${data.user_document_name}</strong>
                            <small class="text-body-secondary timestamp" data-timestamp="${data.timestamp}">${moment(data.timestamp).fromNow()}</small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            ${content}
                        </div>
                    </div>
                `;
            
                $('#toast-container').append(toastHTML);
                let toastEl = new bootstrap.Toast(document.getElementById(`toast-${data.task_id}`));
                toastEl.show();
            }
            
            
        
            // WebSocket handlers
            socket.onopen = () => console.log("WebSocket connection opened.");
            socket.onerror = error => console.error("WebSocket Error:", error);
            socket.onclose = event => event.wasClean ? console.log(`WebSocket connection closed cleanly, code=${event.code}, reason=${event.reason}`) : console.error("WebSocket connection died");
        
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (isToastDismissed(data.task_id) && data.progress !== 100) {
                    return;
                }
                storeToastData(data);

                const existingToast = document.getElementById(`toast-${data.task_id}`);

                if (existingToast) {
                    const toastBody = existingToast.querySelector('.toast-body');
                    const toastHeader = existingToast.querySelector('.toast-header');

                    if (data.error) {
                        toastBody.innerHTML = `
                            ${data.exam_name}
                            <div class="mt-2 alert alert-danger" role="alert">
                                Error: ${data.error}
                            </div>
                            `;

                    } else if (data.progress === 100) {
                        toastBody.innerHTML = `
                            ${data.exam_name}
                            <a class="btn btn-sm btn-outline-success" href="/app/${data.doc_id}/view" onclick="hideToastAndNavigate(event, 'toast-${data.task_id}', '/app/${data.doc_id}/view')">View Marks</a>`;
                        
                    } else {
                        // Update the progress bar for the existing toast
                        const progressBar = existingToast.querySelector('.progress-bar');
                        progressBar.style.width = `${data.progress}%`;
                        progressBar.setAttribute('aria-valuenow', data.progress);
                    }
                } else {
                    // Render a new toast
                    renderToast(data);
                }
            };
            
            
            
        
            $(document).on('hidden.bs.toast', '.toast', function() {
                let toastId = $(this).attr('id').replace('toast-', '');
                let toasts = JSON.parse(localStorage.getItem('toasts')) || [];
                let dismissedToasts = JSON.parse(localStorage.getItem('dismissedToasts')) || [];
            
                toasts = toasts.filter(toast => toast.task_id !== toastId);
                localStorage.setItem('toasts', JSON.stringify(toasts));
            
                if (!dismissedToasts.includes(toastId)) {
                    dismissedToasts.push(toastId);
                    localStorage.setItem('dismissedToasts', JSON.stringify(dismissedToasts));
                }
            });
        
            // Event listeners for htmx and toast
            document.body.addEventListener('htmx:afterSwap', function(event) {
                var toasts = document.querySelectorAll('.toast:not(.show)');
                toasts.forEach(toast => new bootstrap.Toast(toast).show());
            });
            document.body.addEventListener('hidden.bs.toast', event => event.target.remove());

        </script>


        <script>
            // Function to update the timestamp display for all toasts
            function updateTimestamps() {
                $('.timestamp').each(function() {
                    const timestamp = $(this).data('timestamp');
                    $(this).text(moment(timestamp).fromNow());
                });
            }
        
            // Run the function to update timestamps every minute
            setInterval(updateTimestamps, 60 * 1000);
        </script>
        
        



        <script>
        // to get rid of all toasts when logging out etc localStorage.removeItem('toasts');
        </script>
        
    </body>
</html>

