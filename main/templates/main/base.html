{% load static %}
{% load crispy_forms_tags %}
<!doctype html>
<html lang="en">
    <head>
        
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <!-- htmx -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.6/htmx.min.js" integrity="sha512-tGWc4YBM6ag1pJndcieiU2r+lJXdzBRk70mHE13JoGeZI/QdWQkQ6q1CL1xYdJtTOfARf5oPcxJCnS6bLaM+KA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- Math Quill -->
        <link rel="stylesheet" href="{% static 'css/mathquill.css' %}">

        <!-- Styles for PDF viewer -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">




        <!-- MathJax -->
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:400,700|Lato:400,700&display=swap" rel="stylesheet">

        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500&display=swap" rel="stylesheet">

        <link rel="preconnect" href="https://fonts.googleapis.com">

        <!--bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
        <!-- css -->
        <link rel="stylesheet" href="{% static 'css/main.css' %}">
        <title>{% block title%} {% endblock %}</title>

        <!-- font-awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

        <!-- pdf js-->
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js"></script>
        
        <!-- cropper js-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" integrity="sha512-hvNR0F/e2J7zPPfLC9auFe3/SE0yG4aJCOd/qxew74NN7eyiSKjr7xJJMu1Jy2wf7FXITpWS1E/RY8yzuXN7VA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js" integrity="sha512-9KkIqdfN7ipEW6B6k+Aq20PV31bjODg4AA52W+tYtAE0jE0kMx49bjJ3FgvS56wzmyfMUHbQ4Km2b7l9+Y/+Eg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- alert symbols -->
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
            <symbol id="check-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </symbol>
            <symbol id="info-fill" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </symbol>
            <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </symbol>
        </svg>
    </head>
    <body>

        
        <div class="sidenav hide-in-fullscreen">
            <a href="/app/" class="sidenav-brand">
                <img src="path_to_your_logo.png" alt="" class="sidenav-logo"/>
                AICERTA
            </a>
            <a href="/app/">Home</a>
            <div class="dropdown">
                <a class="dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Classes
                </a>
                <ul class="dropdown-menu" data-bs-theme="dark">
                    {% for class in class_list %}
                        <li><a href="/app/classroom/{{class.id}}">{{ class.name }}</a></li>
                    {% empty %}
                        <li><a href="#">No classes</a></li>
                    {% endfor %}

                    {% if user.student == True %}
                        <form method="POST" action="/app/classroom-join/">
                            {% csrf_token %}
                            {{classroom_form|crispy}}
                            <button type='submit' name = "save" class="btn btn-outline-success">submit</button>
                        </form>


                    {% endif %}


                    <li><a class="dropdown-item" href=""></a></li>

                </ul>
            </div>
            {% if user.student == False %}
                <div class="dropdown">
                    <a class="dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Create
                    </a>
                    <ul class="dropdown-menu" data-bs-theme="dark">
                        <li><a class="dropdown-item" href="/app/create">create document</a></li>
                        <li><a class="dropdown-item" href="#">create standard</a></li>
                        <li><a class="dropdown-item" href="/app/createclass">create classroom</a></li>
                        <li><a class="dropdown-item" href="/app/createassignment">create assignment</a></li>
                    </ul>
                </div>
                <div class="dropdown">
                    <a class="dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="path_to_user_pfp.png" alt="" class="user-pfp"/>
                        {{user.email}}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" data-bs-theme="dark">
                        <li><a href="/app/account">Account</a></li>
                        <li><a href="/app/support">Support</a></li>
                        <!-- Other menu items... -->
                    </ul>
                </div> 
            {% endif %}
        </div>

        <div id="content", name="content", class="main">

            <div id="alert-container">
            </div>   
            {% block content%}
            {% endblock %}
        </div>

        <div class="toast-container bottom-0 end-0 p-3" id="toast-container">
        </div>


        

        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
        
        <!-- Mathquill JS-->
        <script src="{% static 'js/mathquill.js' %}"></script>

        <!-- Moment JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>



        
        
        
        <script>
            function hideToastAndNavigate(event, toastId, url) {
                event.preventDefault(); // Prevent default navigation
            
                // Hide the toast
                let toastEl = document.getElementById(toastId);
                let bootstrapToast = new bootstrap.Toast(toastEl);
                bootstrapToast.hide();
            
                // Navigate to the URL after a short delay to ensure the toast hides smoothly
                setTimeout(() => {
                    window.location.href = url;
                }, 300); // 300ms delay, you can adjust as needed
            }
            
        </script>

        <script>
            
            const socket = new WebSocket(
                'ws://' + window.location.host + '/ws/notifications/'
            );
        
            // Function to store toast data in localStorage
            function storeToastData(data) {
                if (isToastDismissed(data.task_id) && data.progress !== 100) {
                    return;
                }
                let toasts = JSON.parse(localStorage.getItem('toasts')) || [];
                data.timestamp = moment().toISOString();

                
                // Check if a toast with the given task_id already exists
                const existingToastIndex = toasts.findIndex(toast => toast.task_id === data.task_id);

                if (existingToastIndex > -1) {
                    // If it exists, update the existing toast data with the new data
                    toasts[existingToastIndex] = data;
                } else {
                    // If it doesn't exist, push the new data to the array
                    toasts.push(data);
                }

                localStorage.setItem('toasts', JSON.stringify(toasts));
            }

            function isToastDismissed(task_id) {
                let dismissedToasts = JSON.parse(localStorage.getItem('dismissedToasts')) || [];
                return dismissedToasts.includes(task_id);
            }
            
            // Function to render a toast
            function renderToast(data) {
                let content;

                if (data.error) {
                    content = `
                        ${data.exam_name}
                        <div class="alert alert-danger mt-2" role="alert">
                            Error: ${data.error}
                        </div>
                        `;
                } else if (data.progress < 100) {
                    content = `
                        ${data.exam_name}
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: ${data.progress}%" aria-valuenow="${data.progress}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        `;
                } else {
                    content = `
                        ${data.exam_name}
                        <a class="btn btn-sm btn-outline-success" href="/app/${data.doc_id}/view" onclick="hideToastAndNavigate(event, 'toast-${data.task_id}', '/app/${data.doc_id}/view')">View Marks</a>`;
                }
            
                let toastHTML = `
                    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false" id="toast-${data.task_id}">
                        <div class="toast-header">
                            <div class="rounded me-2" style="width: 20px; height: 20px; background-color: #376d4d;"></div>
                            <strong class="me-auto">${data.user_document_name}</strong>
                            <small class="text-body-secondary timestamp" data-timestamp="${data.timestamp}">${moment(data.timestamp).fromNow()}</small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            ${content}
                        </div>
                    </div>
                `;
            
                $('#toast-container').append(toastHTML);
                let toastEl = new bootstrap.Toast(document.getElementById(`toast-${data.task_id}`));
                toastEl.show();
            }

            
        
            // WebSocket handlers
            socket.onopen = () => console.log("WebSocket connection opened.");
            socket.onerror = error => console.error("WebSocket Error:", error);
            socket.onclose = event => event.wasClean ? console.log(`WebSocket connection closed cleanly, code=${event.code}, reason=${event.reason}`) : console.error("WebSocket connection died");
        
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log(data);

                if (data.message_type === 'notification') {
                    if (isToastDismissed(data.task_id) && data.progress !== 100) {
                        return;
                    }
                    storeToastData(data);

                    const existingToast = document.getElementById(`toast-${data.task_id}`);

                    if (existingToast) {
                        const toastBody = existingToast.querySelector('.toast-body');
                        const toastHeader = existingToast.querySelector('.toast-header');

                        if (data.error) {
                            toastBody.innerHTML = `
                                ${data.exam_name}
                                <div class="mt-2 alert alert-danger" role="alert">
                                    Error: ${data.error}
                                </div>
                                `;

                        } else if (data.progress === 100) {
                            toastBody.innerHTML = `
                                ${data.exam_name}
                                <a class="btn btn-sm btn-outline-success" href="/app/${data.doc_id}/view" onclick="hideToastAndNavigate(event, 'toast-${data.task_id}', '/app/${data.doc_id}/view')">View Marks</a>`;
                            
                        } else {
                            // Update the progress bar for the existing toast
                            const progressBar = existingToast.querySelector('.progress-bar');
                            progressBar.style.width = `${data.progress}%`;
                            progressBar.setAttribute('aria-valuenow', data.progress);
                        }
                    } else {
                        // Render a new toast
                        renderToast(data);
                    }
                    //setup message queuing for messages sent super quick
                }


                else if (data.message_type === 'alert') {
                    

                    var alertHTML = `
                    <div class="alert alert-${data.alert} alert-dismissible fade show" role="alert">
                        <svg class="bi flex-shrink-0 me-2" role="img" aria-label="${data.alert}"><use xlink:href="#${data.icon}"/></svg>
                        ${data.message}
                        <!--button class="btn btn-sm btn-light">Create Copy</button-->
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    `

                    var alertContainer = document.getElementById('alert-container')
                    alertContainer.innerHTML += alertHTML;
                }






            };
            
        
            // Render stored toasts from localStorage on page load
            $(document).ready(function() {
                let storedToasts = JSON.parse(localStorage.getItem('toasts')) || [];
                storedToasts.forEach(renderToast);
            });

            // Handle the event when a toast is hidden
            $(document).on('hidden.bs.toast', '.toast', function() {
                let toastId = $(this).attr('id').replace('toast-', '');
                let toasts = JSON.parse(localStorage.getItem('toasts')) || [];
                let dismissedToasts = JSON.parse(localStorage.getItem('dismissedToasts')) || [];

                toasts = toasts.filter(toast => toast.task_id !== toastId);
                localStorage.setItem('toasts', JSON.stringify(toasts));

                if (!dismissedToasts.includes(toastId)) {
                    dismissedToasts.push(toastId);
                    localStorage.setItem('dismissedToasts', JSON.stringify(dismissedToasts));
                }
            });

        
            // Event listeners for htmx and toast
            document.body.addEventListener('htmx:afterSwap', function(event) {
                var toasts = document.querySelectorAll('.toast:not(.show)');
                toasts.forEach(toast => new bootstrap.Toast(toast).show());
            });
            document.body.addEventListener('hidden.bs.toast', event => event.target.remove());

        </script>


        <script>
            // Function to update the timestamp display for all toasts
            function updateTimestamps() {
                $('.timestamp').each(function() {
                    const timestamp = $(this).data('timestamp');
                    $(this).text(moment(timestamp).fromNow());
                });
            }
        
            // Run the function to update timestamps every minute
            setInterval(updateTimestamps, 60 * 1000);
        </script>

        {% block scripts%}
        {% endblock %}
        

    </body>
</html>

